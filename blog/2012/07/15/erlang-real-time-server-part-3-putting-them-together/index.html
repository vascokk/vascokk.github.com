
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Erlang Real Time Server - Part 3 - Putting Parts Together - Reinventing The Wheel</title>
  <meta name="author" content="Vasco Kolarov">

  
  <meta name="description" content="The need for load-balancing As you have probably noticed in Part 2 we always send the Riak commands to one and the same node. That doesn&#8217;t seem &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://vascokk.github.com/blog/2012/07/15/erlang-real-time-server-part-3-putting-them-together">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Reinventing The Wheel" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2366459']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Reinventing The Wheel</a></h1>
  
    <h2>because sometimes it's fun</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:vascokk.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Erlang Real Time Server - Part 3 - Putting Parts Together</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-15T17:16:00+01:00" pubdate data-updated="true">Jul 15<span>th</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h2>The need for load-balancing</h2>

<p>As you have probably noticed in <a href="http://vas.io/blog/2012/06/06/erlang-real-time-server-part-2-aggregation/">Part 2</a> we always send the Riak commands to one and the same node. That doesn&#8217;t seem to be right, so, what about some load balanced distibution of the commands among the cluster nodes? There are at least two ways to solve this:</p>

<ul>
<li>send commands from Diameter Server to Riak cluster in load-balanced fashion, or:</li>
<li>couple Diameter server with  RiakCore application in one node and send Diameter messages directly to the RiakCluster in a load-balanced fashion.</li>
</ul>


<p>If we choose the first approach, we can use HTTP or ProtocolBuffer interface to access Riak from <em>diaserver</em> and use some HTTP/TCP proxy to load-balance the requests (e.g. HAProxy is a good one). The inconvenience here comes from the fact that we have to write a separate HTTP POST requests or implement a PB interface for every Diameter command. (But, this is probably a good idea for a future blog post)</p>

<p>In the second case we can use a Diameter Relay/Forward agent to distribute Diameter messages among the cluster or (again) a TCP proxy, since one of the possible Diameter transports is TCP. For the sake of simplicity I&#8217;ll use this approach.</p>

<p>First of all, as our applications will be running on the same Riak cluster, I&#8217;ll change the <em>diaserver</em> callback module. At the moment this module is responsible for creating the Diameter Accounting Answer message. Instead, I&#8217;ll just make a call to aggregation:accounting() function with parameter - the Diameter Accounting Request.</p>

<p>Change the <em>accounting()</em> function in <em>aggregation.erl</em> module:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">accounting</span><span class="p">(</span><span class="nv">Req</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">DocIdx</span> <span class="o">=</span> <span class="nn">riak_core_util</span><span class="p">:</span><span class="n">chash_key</span><span class="p">({</span><span class="o">&lt;&lt;</span><span class="s">&quot;accounting&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nb">term_to_binary</span><span class="p">(</span><span class="n">now</span><span class="p">())}),</span>
</span><span class='line'>    <span class="nv">PrefList</span> <span class="o">=</span> <span class="nn">riak_core_apl</span><span class="p">:</span><span class="n">get_primary_apl</span><span class="p">(</span><span class="nv">DocIdx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">aggregation</span><span class="p">),</span>
</span><span class='line'>    <span class="p">[{</span><span class="nv">IndexNode</span><span class="p">,</span> <span class="p">_</span><span class="nv">Type</span><span class="p">}]</span> <span class="o">=</span> <span class="nv">PrefList</span><span class="p">,</span>
</span><span class='line'>    <span class="nn">riak_core_vnode_master</span><span class="p">:</span><span class="n">sync_spawn_command</span><span class="p">(</span><span class="nv">IndexNode</span><span class="p">,</span> <span class="p">{</span><span class="n">accounting</span><span class="p">,</span> <span class="nv">Req</span><span class="p">},</span> <span class="n">aggregation_vnode_master</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure>


<p>Don&#8217;t forget to change also the arity in the export clause to /1.</p>

<p>Next, the handle_call() in the aggregation_vnode module:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">handle_command</span><span class="p">({</span><span class="n">accounting</span><span class="p">,</span> <span class="nv">Req</span><span class="p">},</span> <span class="p">_</span><span class="nv">Sender</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c">%%TODO Process accounting request</span>
</span><span class='line'>    <span class="nv">Req</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">ResponseCode</span> <span class="o">=</span> <span class="no">?&#39;DIAMETER_BASE_RESULT-CODE_DIAMETER_SUCCESS&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">ResponseCode</span><span class="p">,</span> <span class="nv">State</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>For the sake of the exercise, we are just going to return SUCCESS, but actually this is the place where you should do all the processing of the Diameter request.</p>

<p>The last step is to call aggregation:accounting(Req) from the diameter callback module:</p>

<figure class='code'><figcaption><span>server_cb.erl</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">handle_request</span><span class="p">(</span><span class="nl">#diameter_packet</span><span class="p">{</span><span class="n">msg</span> <span class="o">=</span> <span class="nv">Req</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="p">[]},</span> <span class="p">_</span><span class="nv">SvcName</span><span class="p">,</span> <span class="p">{_,</span> <span class="nv">Caps</span><span class="p">})</span>
</span><span class='line'>                  <span class="k">when</span> <span class="nb">is_record</span><span class="p">(</span><span class="nv">Req</span><span class="p">,</span> <span class="n">diameter_base_ACR</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nl">#diameter_caps</span><span class="p">{</span><span class="n">origin_host</span> <span class="o">=</span> <span class="p">{</span><span class="nv">OH</span><span class="p">,_},</span>
</span><span class='line'>                   <span class="n">origin_realm</span> <span class="o">=</span> <span class="p">{</span><span class="nv">OR</span><span class="p">,_}}</span>
</span><span class='line'>            <span class="o">=</span> <span class="nv">Caps</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>            <span class="nl">#diameter_base_ACR</span><span class="p">{</span><span class="n">&#39;Session-Id&#39;</span> <span class="o">=</span> <span class="nv">Id</span><span class="p">,</span>
</span><span class='line'>                       <span class="n">&#39;Accounting-Record-Type&#39;</span> <span class="o">=</span> <span class="nv">RecType</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">&#39;Accounting-Record-Number&#39;</span> <span class="o">=</span> <span class="nv">RecNum</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">&#39;Acct-Application-Id&#39;</span> <span class="o">=</span> <span class="nv">AccAppId</span> <span class="p">}</span>
</span><span class='line'>            <span class="o">=</span> <span class="nv">Req</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">ResultCode</span> <span class="o">=</span> <span class="nn">aggregation</span><span class="p">:</span><span class="n">accounting</span><span class="p">(</span><span class="nv">Req</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">Ans</span> <span class="o">=</span> <span class="nl">#diameter_base_ACA</span><span class="p">{</span><span class="n">&#39;Result-Code&#39;</span> <span class="o">=</span> <span class="nv">ResultCode</span><span class="p">,</span> <span class="c">%%?&#39;DIAMETER_BASE_RESULT-CODE_DIAMETER_SUCCESS&#39;,</span>
</span><span class='line'>                       <span class="n">&#39;Origin-Host&#39;</span> <span class="o">=</span> <span class="nv">OH</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">&#39;Origin-Realm&#39;</span> <span class="o">=</span> <span class="nv">OR</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">&#39;Session-Id&#39;</span> <span class="o">=</span> <span class="nv">Id</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">&#39;Accounting-Record-Type&#39;</span> <span class="o">=</span> <span class="nv">RecType</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">&#39;Accounting-Record-Number&#39;</span> <span class="o">=</span> <span class="nv">RecNum</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">&#39;Acct-Application-Id&#39;</span> <span class="o">=</span> <span class="nv">AccAppId</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Ans</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, what is left is - to put <em>diaserver</em> and <em>aggregation</em> applications together in one erlang &#8220;release&#8221;:</p>

<h2>Building the &#8220;RTS&#8221; node</h2>

<p>I&#8217;m going to the same as I did in the previous post - using the rebar-riak-core templates, but this time I&#8217;ll use a slightly modified <a href="https://github.com/vascokk/rebar_riak_core/blob/master/riak_core_multinode_simple.template">&#8220;multinode template&#8221;</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd </span>rel
</span><span class='line'><span class="nv">$ </span>mkdir rts
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>rts
</span><span class='line'><span class="nv">$ </span>../../rebar -f create <span class="nv">template</span><span class="o">=</span>riak_core_multinode_simple <span class="nv">nodeid</span><span class="o">=</span>rts <span class="nv">target_dir</span><span class="o">=</span>.
</span><span class='line'>
</span><span class='line'><span class="o">==</span>&gt; rts <span class="o">(</span>create<span class="o">)</span>
</span><span class='line'>Writing ./reltool.config
</span><span class='line'>Writing ./files/erl
</span><span class='line'>Writing ./files/nodetool
</span><span class='line'>Writing ./files/rts
</span><span class='line'>Writing ./files/app.config
</span><span class='line'>Writing ./files/vm.args
</span><span class='line'>Writing .gitignore
</span><span class='line'>Writing Makefile
</span><span class='line'>Writing ./files/rts-admin
</span><span class='line'>Writing ./vars.config
</span><span class='line'>Writing ./vars/dev1.config
</span><span class='line'>Writing ./vars/dev2.config
</span><span class='line'>Writing ./vars/dev3.config
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Now, we have to edit <em>reltool.config</em> and <em>app.config</em>:</p>

<p>For <em>reltool.config</em> we need to:</p>

<ul>
<li>change lib_dirs with appropriate paths</li>
<li>add <em>diaserver</em> and <em>aggregation</em> to the list of application need to be started by this release</li>
<li>add application specific configuration</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">{</span>sys, <span class="o">[</span>    
</span><span class='line'>       <span class="o">{</span>lib_dirs, <span class="o">[</span><span class="s2">&quot;../../apps/&quot;</span>, <span class="s2">&quot;../../deps/&quot;</span><span class="o">]}</span>,
</span><span class='line'>       <span class="o">{</span>rel, <span class="s2">&quot;rts&quot;</span>, <span class="s2">&quot;1&quot;</span>,
</span><span class='line'>        <span class="o">[</span>
</span><span class='line'>         kernel,
</span><span class='line'>         stdlib,
</span><span class='line'>         sasl,
</span><span class='line'>         %% add our applications
</span><span class='line'>         aggregation,
</span><span class='line'>         diaserver
</span><span class='line'>        <span class="o">]}</span>,
</span><span class='line'>       <span class="o">{</span>rel, <span class="s2">&quot;start_clean&quot;</span>, <span class="s2">&quot;&quot;</span>,
</span><span class='line'>        <span class="o">[</span>
</span><span class='line'>         kernel,
</span><span class='line'>         stdlib
</span><span class='line'>        <span class="o">]}</span>,
</span><span class='line'>       <span class="o">{</span>boot_rel, <span class="s2">&quot;rts&quot;</span><span class="o">}</span>,
</span><span class='line'>       <span class="o">{</span>profile, embedded<span class="o">}</span>,
</span><span class='line'>       <span class="o">{</span>excl_sys_filters, <span class="o">[</span><span class="s2">&quot;^bin/.*&quot;</span>,
</span><span class='line'>                           <span class="s2">&quot;^erts.*/bin/(dialyzer|typer)&quot;</span><span class="o">]}</span>,
</span><span class='line'>       <span class="o">{</span>app, sasl, <span class="o">[{</span>incl_cond, include<span class="o">}]}</span>,
</span><span class='line'>       %%add application specific configurations
</span><span class='line'>       <span class="o">{</span>app, aggregation, <span class="o">[{</span>incl_cond, include<span class="o">}]}</span>,
</span><span class='line'>       <span class="o">{</span>app, diaserver, <span class="o">[{</span>incl_cond, include<span class="o">}]}</span>
</span><span class='line'>      <span class="o">]}</span>.
</span><span class='line'>
</span><span class='line'><span class="o">{</span>target_dir, <span class="s2">&quot;rts&quot;</span><span class="o">}</span>.
</span><span class='line'>
</span><span class='line'><span class="o">{</span>overlay_vars, <span class="s2">&quot;vars.config&quot;</span><span class="o">}</span>.
</span><span class='line'>
</span><span class='line'><span class="o">{</span>overlay, <span class="o">[</span>
</span><span class='line'>           <span class="o">{</span>mkdir, <span class="s2">&quot;data/ring&quot;</span><span class="o">}</span>,
</span><span class='line'>           <span class="o">{</span>mkdir, <span class="s2">&quot;log/sasl&quot;</span><span class="o">}</span>,
</span><span class='line'>           <span class="o">{</span>copy, <span class="s2">&quot;files/erl&quot;</span>, <span class="s2">&quot;\{\{erts_vsn\}\}/bin/erl&quot;</span><span class="o">}</span>,
</span><span class='line'>           <span class="o">{</span>copy, <span class="s2">&quot;files/nodetool&quot;</span>, <span class="s2">&quot;\{\{erts_vsn\}\}/bin/nodetool&quot;</span><span class="o">}</span>,
</span><span class='line'>           <span class="o">{</span>template, <span class="s2">&quot;files/app.config&quot;</span>, <span class="s2">&quot;etc/app.config&quot;</span><span class="o">}</span>,
</span><span class='line'>           <span class="o">{</span>template, <span class="s2">&quot;files/vm.args&quot;</span>, <span class="s2">&quot;etc/vm.args&quot;</span><span class="o">}</span>,
</span><span class='line'>           <span class="o">{</span>template, <span class="s2">&quot;files/rts&quot;</span>, <span class="s2">&quot;bin/rts&quot;</span><span class="o">}</span>,
</span><span class='line'>           <span class="o">{</span>template, <span class="s2">&quot;files/rts-admin&quot;</span>, <span class="s2">&quot;bin/rts-admin&quot;</span><span class="o">}</span>
</span><span class='line'>           <span class="o">]}</span>.
</span></code></pre></td></tr></table></div></figure>


<p>For the <em>app.config</em> we need to configure the TCP port on which diaserver will listen.</p>

<div><script src='https://gist.github.com/3146816.js?file='></script>
<noscript><pre><code></code></pre></noscript></div>


<p>I only added the last <em>diaserver</em> tuple. As you see the  is a template parameter. It will be substituted with the value specific for each &#8220;dev&#8221; node. For this purpose we have 3 &#8220;dev&#8221; configuration files in the <em>dev</em> directory. Here is the content of the first one:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>%%
</span><span class='line'>%% etc/app.config
</span><span class='line'>%%
</span><span class='line'><span class="o">{</span>ring_state_dir,        <span class="s2">&quot;data/ring&quot;</span><span class="o">}</span>.
</span><span class='line'><span class="o">{</span>web_ip,                <span class="s2">&quot;127.0.0.1&quot;</span><span class="o">}</span>.
</span><span class='line'><span class="o">{</span>web_port,              <span class="s2">&quot;8091&quot;</span><span class="o">}</span>.
</span><span class='line'><span class="o">{</span>handoff_port,          <span class="s2">&quot;8101&quot;</span><span class="o">}</span>.
</span><span class='line'><span class="o">{</span>diameter_port,         <span class="s2">&quot;7071&quot;</span><span class="o">}</span>.
</span><span class='line'>
</span><span class='line'>%%
</span><span class='line'>%% etc/vm.args
</span><span class='line'>%%
</span><span class='line'><span class="o">{</span>node,                  <span class="s2">&quot;rts1@127.0.0.1&quot;</span><span class="o">}</span>.
</span><span class='line'><span class="o">{</span>cookie,                <span class="s2">&quot;rts&quot;</span><span class="o">}</span>.
</span></code></pre></td></tr></table></div></figure>


<p>In this case I put 7071 for Diameter port, for the other 2 nodes the ports will be 7072 and 7073. Using this &#8220;dev&#8221; configurations will allow us to run 3 (or more if we want) Riak nodes running both <em>aggregation</em> and <em>diaserver</em> applications on the same host.</p>

<p>Compile and build the development release:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;project_root&gt;<span class="nv">$ </span>make
</span><span class='line'>&lt;project_root&gt;<span class="nv">$ </span>make <span class="nv">devrel</span>
</span><span class='line'><span class="o">==</span>&gt; rts <span class="o">(</span>generate<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Last thing - we need the  <em>rel/rts/files/rts-admin</em> script to join our Riak nodes once they are started. If you open this file you&#8217;ll notice that it calls &#8220;myapp_console&#8221; application, we have to change this to &#8220;aggregation_console&#8221; (see the <em>app/aggregation/src</em> directory).</p>

<p>And we are done with the RTS!</p>

<p>We can now run 3 nodes, each one listening for Diameter messages on a different port. As you remember, the initial idea was to distribute the messages to these nodes via TCP proxy, so let&#8217;s:</p>

<h2>Setup the HAProxy</h2>

<p>This part is relatively easy. First download and install the HAProxy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.20.tar.gz
</span><span class='line'>
</span><span class='line'>.....
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>tar -xzf haproxy-1.4.20.tar.gz
</span><span class='line'>
</span><span class='line'>.....
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>haproxy-1.4.20
</span><span class='line'><span class="nv">$ </span>make <span class="nv">TARGET</span><span class="o">=</span>linux26
</span><span class='line'><span class="nv">$ </span>sudo make install
</span></code></pre></td></tr></table></div></figure>


<p>The above <em>make</em> has the option <em>TARGET=linux26</em>, which might be different in your case. To determine the linux kernel version use &#8220;uname -r&#8221; command.</p>

<p>If the HAProxy installation is okay, create a configuration file. In our case it looks like this:</p>

<figure class='code'><figcaption><span>dev.haproxy.config</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>global
</span><span class='line'>  <span class="c"># specify the maximum connections across the board</span>
</span><span class='line'>  maxconn 2048
</span><span class='line'>  <span class="c"># enable debug output</span>
</span><span class='line'>  debug
</span><span class='line'>
</span><span class='line'><span class="c"># now set the default settings for each sub-section</span>
</span><span class='line'>defaults
</span><span class='line'>  <span class="c"># stick with http traffic</span>
</span><span class='line'>  mode http
</span><span class='line'>  <span class="c"># set the number of times HAProxy should attempt to</span>
</span><span class='line'>  <span class="c"># connect to the target</span>
</span><span class='line'>  retries 3
</span><span class='line'>  <span class="c"># specify the number of connections per front and</span>
</span><span class='line'>  <span class="c"># back end</span>
</span><span class='line'>  maxconn 1024
</span><span class='line'>  <span class="c"># specify some timeouts (all in milliseconds)</span>
</span><span class='line'>  timeout connect 5000
</span><span class='line'>
</span><span class='line'><span class="c">########### Riak Configuration ###################</span>
</span><span class='line'>
</span><span class='line'>frontend diaserver
</span><span class='line'>  mode tcp
</span><span class='line'>
</span><span class='line'>  <span class="c"># bind to default DIAMETER port 3868</span>
</span><span class='line'>  <span class="nb">bind </span>127.0.0.1:3868
</span><span class='line'>
</span><span class='line'>  <span class="c"># Default to the riak cluster configuration</span>
</span><span class='line'>  default_backend riak_cluster
</span><span class='line'>
</span><span class='line'>  <span class="c"># timeouts</span>
</span><span class='line'>  timeout client 1200000
</span><span class='line'>
</span><span class='line'><span class="c"># Here is the magic bit which load balances across</span>
</span><span class='line'><span class="c"># our instances of riak_core which are clustered</span>
</span><span class='line'><span class="c"># together</span>
</span><span class='line'>backend riak_cluster
</span><span class='line'>  mode tcp
</span><span class='line'>  balance roundrobin
</span><span class='line'>  <span class="c"># timeouts</span>
</span><span class='line'>  timeout server 1200000
</span><span class='line'>  timeout connect 3000
</span><span class='line'>
</span><span class='line'>  server rts1 127.0.0.1:7071 check
</span><span class='line'>  server rts2 127.0.0.1:7072 check
</span><span class='line'>  server rts3 127.0.0.1:7073 check
</span></code></pre></td></tr></table></div></figure>


<p>The idea here is pretty obvious (right?): our &#8220;frontend&#8221; (i.e. what the external world will see) is the standard Diameter port 3868. All the TCP packets sent to this port will be forwarded on a round-robin fashion to the &#8220;backend&#8221;, which is our 3 dev release erlang nodes, each of them listening to a different diameter port.</p>

<p>And that&#8217;s it! We only need to run everything and see how it works:</p>

<p>Open a terminal window and start the first node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./rel/rts/dev/dev1/bin/rts console
</span><span class='line'>
</span><span class='line'>19:01:11.204 <span class="o">[</span>info<span class="o">]</span> Application crypto started on node <span class="s1">&#39;rts1@127.0.0.1&#39;</span>
</span><span class='line'>19:01:11.208 <span class="o">[</span>info<span class="o">]</span> Application riak_sysmon started on node <span class="s1">&#39;rts1@127.0.0.1&#39;</span>
</span><span class='line'>19:01:11.239 <span class="o">[</span>info<span class="o">]</span> Application inets started on node <span class="s1">&#39;rts1@127.0.0.1&#39;</span>
</span><span class='line'>19:01:11.243 <span class="o">[</span>info<span class="o">]</span> Application mochiweb started on node <span class="s1">&#39;rts1@127.0.0.1&#39;</span>
</span><span class='line'>** Found 0 name clashes in code paths
</span><span class='line'>19:01:11.277 <span class="o">[</span>info<span class="o">]</span> Application webmachine started on node <span class="s1">&#39;rts1@127.0.0.1&#39;</span>
</span><span class='line'>19:01:11.311 <span class="o">[</span>info<span class="o">]</span> Application os_mon started on node <span class="s1">&#39;rts1@127.0.0.1&#39;</span>
</span><span class='line'>19:01:11.322 <span class="o">[</span>info<span class="o">]</span> Application folsom started on node <span class="s1">&#39;rts1@127.0.0.1&#39;</span>
</span><span class='line'>19:01:11.470 <span class="o">[</span>info<span class="o">]</span> New capability: <span class="o">{</span>riak_core,vnode_routing<span class="o">}</span> <span class="o">=</span> proxy
</span><span class='line'>19:01:11.471 <span class="o">[</span>info<span class="o">]</span> New capability: <span class="o">{</span>riak_core,staged_joins<span class="o">}</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>19:01:11.473 <span class="o">[</span>info<span class="o">]</span> Application riak_core started on node <span class="s1">&#39;rts1@127.0.0.1&#39;</span>
</span><span class='line'>19:01:11.509 <span class="o">[</span>info<span class="o">]</span> Waiting <span class="k">for </span>application aggregation to start <span class="o">(</span>0 seconds<span class="o">)</span>.
</span><span class='line'>19:01:11.515 <span class="o">[</span>info<span class="o">]</span> Application aggregation started on node <span class="s1">&#39;rts1@127.0.0.1&#39;</span>
</span><span class='line'>19:01:11.568 <span class="o">[</span>info<span class="o">]</span> Application diameter started on node <span class="s1">&#39;rts1@127.0.0.1&#39;</span>
</span><span class='line'>19:01:11.575 <span class="o">[</span>info<span class="o">]</span> Starting diameter on IP: <span class="o">{</span>127,0,0,1<span class="o">}</span>
</span><span class='line'>19:01:11.575 <span class="o">[</span>info<span class="o">]</span> Starting diameter on port: 7071
</span><span class='line'>19:01:11.611 <span class="o">[</span>info<span class="o">]</span> Wait <span class="nb">complete </span><span class="k">for </span>application aggregation <span class="o">(</span>0 seconds<span class="o">)</span>
</span><span class='line'>19:01:11.614 <span class="o">[</span>info<span class="o">]</span> Application diaserver started on node <span class="s1">&#39;rts1@127.0.0.1&#39;</span>
</span><span class='line'>Eshell V5.9.1  <span class="o">(</span>abort with ^G<span class="o">)</span>
</span><span class='line'><span class="o">(</span>rts1@127.0.0.1<span class="o">)</span>1&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Open a new terminal and start the second node and join it to the first one::</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rel/rts/dev/dev2/bin/rts start
</span><span class='line'><span class="nv">$ </span>rel/rts/dev/dev2/bin/rts-admin join rts1@127.0.0.1
</span><span class='line'>Sent join request to rts1@127.0.0.1
</span><span class='line'>
</span><span class='line'>....on the first one you should get:
</span><span class='line'>
</span><span class='line'><span class="o">(</span>rts1@127.0.0.1<span class="o">)</span>1&gt; 20:13:44.622 <span class="o">[</span>info<span class="o">]</span> <span class="s1">&#39;rts2@127.0.0.1&#39;</span> joined cluster with status <span class="s1">&#39;valid&#39;</span>
</span><span class='line'>
</span><span class='line'>....attach to the second rts console:
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>rel/rts/dev/dev2/bin/rts attach
</span></code></pre></td></tr></table></div></figure>


<p>Now, run the HAProxy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> <span class="nv">$ </span>sudo haproxy -f dev.haproxy.config -d
</span><span class='line'>Available polling systems :
</span><span class='line'>     sepoll : <span class="nv">pref</span><span class="o">=</span>400,  <span class="nb">test </span>result OK
</span><span class='line'>      epoll : <span class="nv">pref</span><span class="o">=</span>300,  <span class="nb">test </span>result OK
</span><span class='line'>       poll : <span class="nv">pref</span><span class="o">=</span>200,  <span class="nb">test </span>result OK
</span><span class='line'>     <span class="k">select</span> : <span class="nv">pref</span><span class="o">=</span>150,  <span class="nb">test </span>result OK
</span><span class='line'>Total: 4 <span class="o">(</span>4 usable<span class="o">)</span>, will use sepoll.
</span><span class='line'>Using sepoll<span class="o">()</span> as the polling mechanism.
</span><span class='line'><span class="o">[</span>WARNING<span class="o">]</span> 200/202744 <span class="o">(</span>10525<span class="o">)</span> : Server riak_cluster/rts3 is DOWN, reason: Layer4 connection problem, info: <span class="s2">&quot;Connection refused&quot;</span>, check duration: 0ms. 2 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue.
</span></code></pre></td></tr></table></div></figure>


<p>Run another erlang shell and test with diameter client (see Part 2):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Eshell V5.9.1  <span class="o">(</span>abort with ^G<span class="o">)</span>
</span><span class='line'>1&gt; diameter:start<span class="o">()</span>.
</span><span class='line'>ok
</span><span class='line'>2&gt; client:start<span class="o">()</span>.
</span><span class='line'>ok
</span><span class='line'>3&gt; client:connect<span class="o">(</span>tcp<span class="o">)</span>.
</span><span class='line'><span class="o">{</span>ok,#Ref&lt;0.0.0.50&gt;<span class="o">}</span>
</span><span class='line'>4&gt; client:call_ACR<span class="o">()</span>.
</span><span class='line'><span class="o">{</span>ok,<span class="o">{</span>diameter_base_ACA,<span class="s2">&quot;client;1404231385;1;nonode@nohost&quot;</span>,
</span><span class='line'>                       2001,<span class="s2">&quot;diameter_srv.example.com&quot;</span>,<span class="s2">&quot;example.com&quot;</span>,1,1,<span class="o">[]</span>,
</span><span class='line'>                       <span class="o">[]</span>,<span class="o">[]</span>,<span class="o">[]</span>,<span class="o">[]</span>,<span class="o">[]</span>,<span class="o">[]</span>,<span class="o">[]</span>,<span class="o">[]</span>,<span class="o">[]</span>,<span class="o">[]</span>,<span class="o">[]</span>,<span class="o">[]}}</span>
</span><span class='line'>5&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>....you should see the connection request accepted on the console running the HAProxy:
</span><span class='line'>
</span><span class='line'>00000000:diaserver.accept<span class="o">(</span>0004<span class="o">)=</span>0005 from <span class="o">[</span>127.0.0.1:33979<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you execute the client:call_ACR() several times, you should see the request going to the first or the second node. The balance policy is not really a round-robin, because we have another routing layer in RiacCore, which sends the requests to the appropriate Riak partition.</p>

<p>You can now create a release node (execute: <em>make rel</em>), deploy the node on several AWS instances and here we go - a real-time billing in the cloud :-) Well, of course,  we are not even close to this - we need to implement all the Diameter commands and we need a backend system to manage our subscribers and tariffs, but at least, we just built some foundations for a Riak-based AAA system.</p>

<p>Project files are available one GitHub in repository <a href="https://github.com/vascokk/diameter-test">diameter_test</a>. Happy hacking! :-)</p>

<h2>Credits</h2>

<ul>
<li>OJ Reeves for the HAProxy <a href="http://buffered.io/posts/webmachine-erlydtl-and-riak-part-2/">mini-tutorial</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Vasco Kolarov</span></span>

      








  


<time datetime="2012-07-15T17:16:00+01:00" pubdate data-updated="true">Jul 15<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/diameter/'>Diameter</a>, <a class='category' href='/blog/categories/erlang/'>Erlang</a>, <a class='category' href='/blog/categories/riak/'>Riak</a>, <a class='category' href='/blog/categories/riakcore/'>RiakCore</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://vascokk.github.com/blog/2012/07/15/erlang-real-time-server-part-3-putting-them-together/" data-via="vasco_kk" data-counturl="http://vascokk.github.com/blog/2012/07/15/erlang-real-time-server-part-3-putting-them-together/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/06/06/erlang-real-time-server-part-2-aggregation/" title="Previous Post: Erlang Real Time Server - Part 2 - Aggregation">&laquo; Erlang Real Time Server - Part 2 - Aggregation</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/03/23/erlang-how-to-create-and-compile-module-in-run-time/" title="Next Post: Erlang: How to create and compile module in run-time">Erlang: How to create and compile module in run-time &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/03/23/machine-learning-in-erlang-and-cuda/">Machine Learning in Erlang and CUDA</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/23/erlang-how-to-create-and-compile-module-in-run-time/">Erlang: How to create and compile module in run-time</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/15/erlang-real-time-server-part-3-putting-them-together/">Erlang Real Time Server - Part 3 - Putting Parts Together</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/06/erlang-real-time-server-part-2-aggregation/">Erlang Real Time Server - Part 2 - Aggregation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/13/erlang-real-time-server-part-1-diameter-server/">Erlang Real Time Server - Part 1 - Diameter Server</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/vascokk">@vascokk</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'vascokk',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("vasco_kk", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/vasco_kk" class="twitter-follow-button" data-show-count="false">Follow @vasco_kk</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Vasco Kolarov -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'vasio';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://vascokk.github.com/blog/2012/07/15/erlang-real-time-server-part-3-putting-them-together/';
        var disqus_url = 'http://vascokk.github.com/blog/2012/07/15/erlang-real-time-server-part-3-putting-them-together/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
